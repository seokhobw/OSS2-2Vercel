<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>선수 추가 · Tottenham 2023</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="my.css" />
</head>
<body class="container my-4">
  <div class="page-header mb-3">
    <h1>선수 추가</h1>
    <a class="btn btn-secondary" href="./index.html">목록</a>
  </div>

  <form id="form" novalidate>
    <div class="row g-3">
      <div class="col-6">
        <label class="form-label" for="number">등번호</label>
        <input class="form-control" type="number" id="number" min="1" max="99" required />
        <div class="invalid-feedback">등번호(1~99)를 입력하세요. (중복 금지)</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="name">이름</label>
        <input class="form-control" type="text" id="name" minlength="2" required />
        <div class="invalid-feedback">이름(2자 이상)을 입력하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="position">포지션</label>
        <select class="form-select" id="position" required>
          <option value="">선택</option>
          <option>GK</option><option>DF</option><option>MF</option><option>FW</option>
        </select>
        <div class="invalid-feedback">포지션을 선택하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="nation">국적</label>
        <input class="form-control" type="text" id="nation" required />
        <div class="invalid-feedback">국적을 입력하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="birth">생년월일</label>
        <input class="form-control" type="date" id="birth" required />
        <div class="invalid-feedback">유효한 생년월일을 선택하세요.</div>
        <div class="form-hint">미성년(만 15세 미만) 입력 불가</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="salary">연봉(€)</label>
        <input class="form-control" type="number" id="salary" min="0" step="1000" required />
        <div class="invalid-feedback">0 이상 숫자로 입력하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="foot">주발</label>
        <select class="form-select" id="foot" required>
          <option value="">선택</option>
          <option>Right</option><option>Left</option><option>Both</option>
        </select>
        <div class="invalid-feedback">주발을 선택하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="height">키(cm)</label>
        <input class="form-control" type="number" id="height" min="140" max="230" required />
        <div class="invalid-feedback">키(140~230) 범위를 입력하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="status">상태</label>
        <select class="form-select" id="status" required>
          <option value="">선택</option>
          <option>Active</option><option>Injured</option><option>Captain</option>
        </select>
        <div class="invalid-feedback">상태를 선택하세요.</div>
      </div>
    </div>

    <div class="footer-nav">
      <button class="btn btn-primary" type="submit">확인</button>
      <a class="btn btn-outline-secondary" href="./index.html">취소</a>
    </div>
  </form>

  <script>
    const KEY = "players";
    function getPlayers(){ const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : []; }
    function setPlayers(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function isAdult(d){ const b = new Date(d); if(isNaN(b)) return false; const now = new Date(); const diff = now.getFullYear()-b.getFullYear(); if(diff>15) return true; if(diff<15) return false; const month = now.getMonth()-b.getMonth(); if(month>0) return true; if(month<0) return false; return now.getDate()>=b.getDate(); }

    const form = document.getElementById("form");
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      e.stopPropagation();

      // Show built-in validation styles first
      form.classList.add("was-validated");

      const number = Number(document.getElementById("number").value);
      const name   = document.getElementById("name").value.trim();
      const position = document.getElementById("position").value;
      const nation   = document.getElementById("nation").value.trim();
      const birth    = document.getElementById("birth").value;
      const salary   = Number(document.getElementById("salary").value);
      const foot     = document.getElementById("foot").value;
      const height   = Number(document.getElementById("height").value);
      const status   = document.getElementById("status").value;

      let valid = true;

      if (!form.checkValidity()) valid = false;

      if(!(number>=1 && number<=99)) valid=false;
      if(name.length<2) valid=false;
      if(!position) valid=false;
      if(!nation) valid=false;
      if(!birth || !isAdult(birth)) valid=false;
      if(!(salary>=0)) valid=false;
      if(!foot) valid=false;
      if(!(height>=140 && height<=230)) valid=false;
      if(!status) valid=false;

      const exists = getPlayers().some(p => p.number === number);
      if (exists) {
        valid = false;
        alert("이미 존재하는 등번호입니다.");
      }

      if (!valid) return; // stop here when invalid

      // 4) Save and show success alert reliably
      const players = getPlayers();
      players.push({ number, name, position, nation, birth, salary, foot, height, status });
      setPlayers(players);

      // Ensure the alert is shown before navigation
      setTimeout(() => { location.href = "./index.html"; }, 0);
      alert("게시물이 추가됩니다");
    });
  </script>
</body>
</html>