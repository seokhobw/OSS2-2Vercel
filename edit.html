<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>선수 수정 · Tottenham 2023</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="my.css" />
</head>
<body class="container my-4">
  <div class="page-header mb-3">
    <h1>선수 수정</h1>
    <a class="btn btn-secondary" href="./index.html">목록</a>
  </div>

  <form id="form" novalidate>
    <div class="row g-3">
      <div class="col-6">
        <label class="form-label" for="number">등번호</label>
        <input class="form-control" type="number" id="number" min="1" max="99" required />
        <div class="invalid-feedback">등번호(1~99)를 입력하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="name">이름</label>
        <input class="form-control" type="text" id="name" minlength="2" required />
        <div class="invalid-feedback">이름(2자 이상)을 입력하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="position">포지션</label>
        <select class="form-select" id="position" required>
          <option value="">선택</option>
          <option>GK</option><option>DF</option><option>MF</option><option>FW</option>
        </select>
        <div class="invalid-feedback">포지션을 선택하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="nation">국적</label>
        <input class="form-control" type="text" id="nation" required />
        <div class="invalid-feedback">국적을 입력하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="birth">생년월일</label>
        <input class="form-control" type="date" id="birth" required />
        <div class="invalid-feedback">유효한 생년월일을 선택하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="salary">연봉(€)</label>
        <input class="form-control" type="number" id="salary" min="0" step="1000" required />
        <div class="invalid-feedback">0 이상 숫자로 입력하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="foot">주발</label>
        <select class="form-select" id="foot" required>
          <option value="">선택</option>
          <option>Right</option><option>Left</option><option>Both</option>
        </select>
        <div class="invalid-feedback">주발을 선택하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="height">키(cm)</label>
        <input class="form-control" type="number" id="height" min="140" max="230" required />
        <div class="invalid-feedback">키(140~230) 범위를 입력하세요.</div>
      </div>
      <div class="col-6">
        <label class="form-label" for="status">상태</label>
        <select class="form-select" id="status" required>
          <option value="">선택</option>
          <option>Active</option><option>Injured</option><option>Captain</option>
        </select>
        <div class="invalid-feedback">상태를 선택하세요.</div>
      </div>
    </div>

    <div class="footer-nav">
      <button class="btn btn-primary" type="submit">확인</button>
      <a class="btn btn-outline-secondary" href="./index.html">취소</a>
    </div>
  </form>

  <script>
    const KEY = "players";
    const params = new URLSearchParams(location.search);
    const original = Number(params.get("number"));
    function getPlayers(){ const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : []; }
    function setPlayers(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function isAdult(d){ const b = new Date(d); if(isNaN(b)) return false; const now = new Date(); const diff = now.getFullYear()-b.getFullYear(); if(diff>15) return true; if(diff<15) return false; const month = now.getMonth()-b.getMonth(); if(month>0) return true; if(month<0) return false; return now.getDate()>=b.getDate(); }

    const form = document.getElementById("form");
    const players = getPlayers();
    const p = players.find(x => x.number === original);
    if(!p){ alert("선수 정보를 찾을 수 없습니다."); location.href = "./index.html"; }



    number.value = p.number;
    name.value = p.name;
    position.value = p.position;
    nation.value = p.nation;
    birth.value = p.birth;
    salary.value = p.salary;
    foot.value = p.foot;
    height.value = p.height;
    status.value = p.status;

    form.addEventListener("submit", (e) => {
      e.preventDefault(); e.stopPropagation();
      const next = {
        number: Number(document.getElementById("number").value),
        name: document.getElementById("name").value.trim(),
        position: document.getElementById("position").value,
        nation: document.getElementById("nation").value.trim(),
        birth: document.getElementById("birth").value,
        salary: Number(document.getElementById("salary").value),
        foot: document.getElementById("foot").value,
        height: Number(document.getElementById("height").value),
        status: document.getElementById("status").value
      };
      let valid = true;
      if(!(next.number>=1 && next.number<=99)) valid=false;
      if(next.name.length<2) valid=false;
      if(!next.position) valid=false;
      if(!next.nation) valid=false;
      if(!next.birth || !isAdult(next.birth)) valid=false;
      if(!(next.salary>=0)) valid=false;
      if(!next.foot) valid=false;
      if(!(next.height>=140 && next.height<=230)) valid=false;
      if(!next.status) valid=false;
      // duplicate number check except self
      if(players.some(x => x.number === next.number && x.number !== original)){
        valid=false; alert("이미 다른 선수가 사용 중인 등번호입니다.");
      }
      form.classList.add("was-validated");
      if(valid && confirm("게시물을 수정할까요?")){
        const idx = players.findIndex(x => x.number === original);
        players[idx] = next;
        setPlayers(players);
        location.href = `./view.html?number=${encodeURIComponent(next.number)}`;
      }
    });
  </script>
</body>
</html>